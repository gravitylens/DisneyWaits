<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Disney Wait Times</title>
</head>
<body>
  <h1>Disney Wait Times</h1>
  <label for="park-select">Park:</label>
  <select id="park-select">
    <option value="">Select a park</option>
  </select>
  <table id="rides-table">
    <thead>
      <tr><th>Ride</th><th>Wait Time</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <table id="closed-rides-table">
    <thead>
      <tr><th>Ride</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <p>Powered by <a href="https://queue-times.com/">Queue-Times.com</a></p>
  <script>
    async function loadParks() {
      const response = await fetch('/parks');
      const parks = await response.json();
      const select = document.getElementById('park-select');
      for (const [id, name] of Object.entries(parks)) {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = name;
        select.appendChild(option);
      }
    }

    async function loadRides(parkId) {
      if (!parkId) {
        return;
      }
      const response = await fetch(`/wait_times?park_id=${parkId}`);
      const rides = await response.json();

      const openRides = rides
        .filter(ride => ride.is_open && ride.mean !== 0)
        .sort((a, b) => {
          if (a.is_unusually_low && !b.is_unusually_low) return -1;
          if (!a.is_unusually_low && b.is_unusually_low) return 1;
          return (a.current_wait ?? 0) - (b.current_wait ?? 0);
        });

      const openBody = document.querySelector('#rides-table tbody');
      openBody.innerHTML = '';
      for (const ride of openRides) {
        const row = document.createElement('tr');
        const nameCell = document.createElement('td');
        nameCell.textContent = ride.name;
        const waitCell = document.createElement('td');
        waitCell.textContent = ride.current_wait;
        row.appendChild(nameCell);
        row.appendChild(waitCell);
        openBody.appendChild(row);
      }

      const closedRides = rides.filter(ride => !ride.is_open);
      const closedBody = document.querySelector('#closed-rides-table tbody');
      closedBody.innerHTML = '';
      for (const ride of closedRides) {
        const row = document.createElement('tr');
        const nameCell = document.createElement('td');
        nameCell.textContent = ride.name;
        const statusCell = document.createElement('td');
        statusCell.textContent = 'Closed';
        row.appendChild(nameCell);
        row.appendChild(statusCell);
        closedBody.appendChild(row);
      }
    }

    let refreshTimer;
    document.getElementById('park-select').addEventListener('change', (e) => {
      const parkId = e.target.value;
      loadRides(parkId);
      if (refreshTimer) {
        clearInterval(refreshTimer);
      }
      if (parkId) {
        refreshTimer = setInterval(() => loadRides(parkId), 60000);
      }
    });

    loadParks();
  </script>
</body>
</html>
